name: CI Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  conda-tests:
    name: Conda Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Checkout Molecule Repository
        uses: actions/checkout@v4
        with:
          repository: ReactionMechanismGenerator/molecule
          path: ./code/Molecule

      - name: Checkout RMG-database Repository
        uses: actions/checkout@v4
        with:
          repository: ReactionMechanismGenerator/RMG-database
          path: ./code/RMG-database

      - name: Set up miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          activate-environment: tck_env
          miniconda-version: latest
          conda-solver: libmamba

      - name: Install Molecule
        run: conda env create -f ./code/Molecule/environment.yml

      - name: Build Molecule
        run: conda run -n molecule_env make -C ./code/Molecule

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=${{ github.workspace }}/tckdb:${{ github.workspace }}/code/Molecule:${{ github.workspace }}/code/RMG-database:${{ github.workspace }}" >> $GITHUB_ENV

      - name: Update PATH
        run: |
          echo "PATH=${{ github.workspace }}/code/Molecule:${{ github.workspace }}/code/RMG-database:${{ github.workspace }}/tckdb:$PATH" >> $GITHUB_ENV

      - name: Run All Tests with Coverage
        run: make test-all

      - name: Trunk Check
        uses: trunk-io/trunk-action@v1

      - name: Codecov Coverage
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false
          files: ./coverage.xml
          flags: unittests # optional
          name: codecov-umbrella # optional
          verbose: true # optional (default = false)
          token: 62d527a2-32da-49f4-ac7a-8c5d7b193e57

      - name: Collect Logs on Failure
        if: failure()
        run: |
          echo "Tests failed. Please check the logs for details."
